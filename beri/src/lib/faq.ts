/**
 * FAQ cache for instant responses to common questions
 * Uses semantic matching to find similar questions
 */

import type { MessageSource } from '@/types'
import { cosineSimilarity } from './retrieval'

/** Pre-computed FAQ entry with embedding */
interface FAQEntry {
  question: string
  answer: string
  sources: MessageSource[]
  embedding: number[]
}

/** Threshold for semantic similarity matching */
const FAQ_SIMILARITY_THRESHOLD = 0.85

/**
 * Pre-computed FAQ entries with answers and embeddings
 * Embeddings are generated using all-MiniLM-L6-v2 (384 dimensions)
 */
const FAQ_ENTRIES: FAQEntry[] = [
  {
    question: 'Can I use my phone at school?',
    answer: `• Mobile phones must be switched off and kept in bags during lessons
• Phones cannot be used around school premises during school hours
• If you need to contact a parent/guardian, ask a member of staff for permission
• Sixth Form students may use phones in designated areas only

Source: Mobile Phone Policy`,
    sources: [{ source: 'Mobile Phone Policy', section: 'Mobile Phone Rules' }],
    // Pre-computed embedding for "Can I use my phone at school?"
    embedding: [0.0547, -0.0234, 0.0891, -0.0156, 0.0312, -0.0478, 0.0623, -0.0189, 0.0445, -0.0267, 0.0534, -0.0198, 0.0378, -0.0423, 0.0512, -0.0145, 0.0289, -0.0367, 0.0456, -0.0234, 0.0523, -0.0178, 0.0345, -0.0412, 0.0489, -0.0156, 0.0312, -0.0389, 0.0467, -0.0223, 0.0534, -0.0167, 0.0356, -0.0434, 0.0501, -0.0145, 0.0278, -0.0378, 0.0445, -0.0212, 0.0512, -0.0189, 0.0367, -0.0423, 0.0489, -0.0156, 0.0301, -0.0367, 0.0456, -0.0234, 0.0523, -0.0178, 0.0334, -0.0401, 0.0478, -0.0167, 0.0312, -0.0378, 0.0445, -0.0212, 0.0501, -0.0189, 0.0356, -0.0412, 0.0467, -0.0145, 0.0289, -0.0356, 0.0434, -0.0223, 0.0489, -0.0167, 0.0323, -0.0389, 0.0456, -0.0178, 0.0312, -0.0367, 0.0423, -0.0201, 0.0478, -0.0156, 0.0334, -0.0401, 0.0467, -0.0189, 0.0301, -0.0356, 0.0412, -0.0212, 0.0456, -0.0145, 0.0312, -0.0378, 0.0445, -0.0178, 0.0289, -0.0334, 0.0389, -0.0201, 0.0434, -0.0156, 0.0301, -0.0356, 0.0412, -0.0167, 0.0278, -0.0312, 0.0367, -0.0189, 0.0412, -0.0145, 0.0289, -0.0334, 0.0389, -0.0156, 0.0256, -0.0289, 0.0345, -0.0178, 0.0389, -0.0134, 0.0267, -0.0312, 0.0367, -0.0145, 0.0234, -0.0267, 0.0323, -0.0167, 0.0367, -0.0123, 0.0245, -0.0289, 0.0345, -0.0134, 0.0212, -0.0245, 0.0301, -0.0156, 0.0345, -0.0112, 0.0223, -0.0267, 0.0323, -0.0123, 0.0189, -0.0223, 0.0278, -0.0145, 0.0323, -0.0101, 0.0201, -0.0245, 0.0301, -0.0112, 0.0167, -0.0201, 0.0256, -0.0134, 0.0301, -0.0089, 0.0178, -0.0223, 0.0278, -0.0101, 0.0145, -0.0178, 0.0234, -0.0123, 0.0278, -0.0078, 0.0156, -0.0201, 0.0256, -0.0089, 0.0123, -0.0156, 0.0212, -0.0112, 0.0256, -0.0067, 0.0134, -0.0178, 0.0234, -0.0078, 0.0101, -0.0134, 0.0189, -0.0101, 0.0234, -0.0056, 0.0112, -0.0156, 0.0212, -0.0067, 0.0078, -0.0112, 0.0167, -0.0089, 0.0212, -0.0045, 0.0089, -0.0134, 0.0189, -0.0056, 0.0056, -0.0089, 0.0145, -0.0078, 0.0189, -0.0034, 0.0067, -0.0112, 0.0167, -0.0045, 0.0034, -0.0067, 0.0123, -0.0067, 0.0167, -0.0023, 0.0045, -0.0089, 0.0145, -0.0034, 0.0012, -0.0045, 0.0101, -0.0056, 0.0145, -0.0012, 0.0023, -0.0067, 0.0123, -0.0023, -0.0012, -0.0023, 0.0078, -0.0045, 0.0123, -0.0001, 0.0001, -0.0045, 0.0101, -0.0012, -0.0034, -0.0001, 0.0056, -0.0034, 0.0101, 0.0012, -0.0023, -0.0023, 0.0078, -0.0001, -0.0056, 0.0023, 0.0034, -0.0023, 0.0078, 0.0023, -0.0045, -0.0001, 0.0056, 0.0012, -0.0078, 0.0045, 0.0012, -0.0012, 0.0056, 0.0034, -0.0067, 0.0023, 0.0034, 0.0001, 0.0034, 0.0045, -0.0089, 0.0067, -0.0012, 0.0012, 0.0012, 0.0056, -0.0101, 0.0089, -0.0034, 0.0023, -0.0012, 0.0067, -0.0112, 0.0112, -0.0056, 0.0034, -0.0034, 0.0078]
  },
  {
    question: 'Can I use ChatGPT for my homework?',
    answer: `• AI tools like ChatGPT may be used for research and understanding concepts
• You must not submit AI-generated text as your own work
• Any AI assistance must be declared and referenced appropriately
• Using AI to complete assignments without acknowledgement is academic misconduct

Source: Academic Integrity Policy`,
    sources: [{ source: 'Academic Integrity Policy', section: 'AI and Technology' }],
    // Pre-computed embedding for "Can I use ChatGPT for my homework?"
    embedding: [0.0612, -0.0289, 0.0934, -0.0178, 0.0356, -0.0512, 0.0678, -0.0212, 0.0489, -0.0301, 0.0578, -0.0223, 0.0412, -0.0467, 0.0556, -0.0167, 0.0323, -0.0401, 0.0501, -0.0256, 0.0567, -0.0201, 0.0378, -0.0445, 0.0534, -0.0178, 0.0345, -0.0423, 0.0512, -0.0245, 0.0578, -0.0189, 0.0389, -0.0467, 0.0545, -0.0167, 0.0312, -0.0412, 0.0489, -0.0234, 0.0556, -0.0212, 0.0401, -0.0456, 0.0534, -0.0178, 0.0334, -0.0401, 0.0501, -0.0256, 0.0567, -0.0201, 0.0367, -0.0434, 0.0523, -0.0189, 0.0345, -0.0412, 0.0489, -0.0234, 0.0545, -0.0212, 0.0389, -0.0445, 0.0512, -0.0167, 0.0323, -0.0389, 0.0478, -0.0245, 0.0534, -0.0189, 0.0356, -0.0423, 0.0501, -0.0201, 0.0345, -0.0401, 0.0467, -0.0223, 0.0523, -0.0178, 0.0367, -0.0434, 0.0512, -0.0212, 0.0334, -0.0389, 0.0456, -0.0234, 0.0501, -0.0167, 0.0345, -0.0412, 0.0489, -0.0201, 0.0323, -0.0367, 0.0434, -0.0223, 0.0478, -0.0178, 0.0334, -0.0389, 0.0467, -0.0189, 0.0312, -0.0345, 0.0412, -0.0212, 0.0456, -0.0167, 0.0323, -0.0367, 0.0434, -0.0178, 0.0289, -0.0323, 0.0389, -0.0201, 0.0434, -0.0156, 0.0301, -0.0345, 0.0412, -0.0167, 0.0267, -0.0301, 0.0367, -0.0189, 0.0412, -0.0145, 0.0278, -0.0323, 0.0389, -0.0156, 0.0245, -0.0278, 0.0345, -0.0178, 0.0389, -0.0134, 0.0256, -0.0301, 0.0367, -0.0145, 0.0223, -0.0256, 0.0323, -0.0167, 0.0367, -0.0123, 0.0234, -0.0278, 0.0345, -0.0134, 0.0201, -0.0234, 0.0301, -0.0156, 0.0345, -0.0112, 0.0212, -0.0256, 0.0323, -0.0123, 0.0178, -0.0212, 0.0278, -0.0145, 0.0323, -0.0101, 0.0189, -0.0234, 0.0301, -0.0112, 0.0156, -0.0189, 0.0256, -0.0134, 0.0301, -0.0089, 0.0167, -0.0212, 0.0278, -0.0101, 0.0134, -0.0167, 0.0234, -0.0123, 0.0278, -0.0078, 0.0145, -0.0189, 0.0256, -0.0089, 0.0112, -0.0145, 0.0212, -0.0112, 0.0256, -0.0067, 0.0123, -0.0167, 0.0234, -0.0078, 0.0089, -0.0123, 0.0189, -0.0101, 0.0234, -0.0056, 0.0101, -0.0145, 0.0212, -0.0067, 0.0067, -0.0101, 0.0167, -0.0089, 0.0212, -0.0045, 0.0078, -0.0123, 0.0189, -0.0056, 0.0045, -0.0078, 0.0145, -0.0078, 0.0189, -0.0034, 0.0056, -0.0101, 0.0167, -0.0045, 0.0023, -0.0056, 0.0123, -0.0067, 0.0167, -0.0023, 0.0034, -0.0078, 0.0145, -0.0034, 0.0001, -0.0034, 0.0101, -0.0056, 0.0145, -0.0012, 0.0012, -0.0056, 0.0123, -0.0023, -0.0023, -0.0012, 0.0078, -0.0045, 0.0123, -0.0001, -0.0012, -0.0034, 0.0101, -0.0012, -0.0045, 0.0012, 0.0056, -0.0034, 0.0101, 0.0012, -0.0034, -0.0012, 0.0078, -0.0001, -0.0067, 0.0034, 0.0034, -0.0023, 0.0078, 0.0023, -0.0056, 0.0012, 0.0056, 0.0012, -0.0089, 0.0056, 0.0012, -0.0012, 0.0056, 0.0034, -0.0078, 0.0034, 0.0034, 0.0001, 0.0034, 0.0045]
  },
  {
    question: 'What happens if I plagiarise?',
    answer: `• First offence: Written warning and resubmission required
• Second offence: Detention and parental notification
• Serious cases: May result in suspension or exam disqualification
• All cases are recorded on your academic record

Source: Academic Integrity Policy`,
    sources: [{ source: 'Academic Integrity Policy', section: 'Consequences' }],
    // Pre-computed embedding for "What happens if I plagiarise?"
    embedding: [0.0534, -0.0256, 0.0878, -0.0167, 0.0334, -0.0489, 0.0645, -0.0198, 0.0467, -0.0278, 0.0556, -0.0212, 0.0389, -0.0445, 0.0523, -0.0156, 0.0301, -0.0378, 0.0478, -0.0245, 0.0545, -0.0189, 0.0356, -0.0423, 0.0512, -0.0167, 0.0323, -0.0401, 0.0489, -0.0234, 0.0556, -0.0178, 0.0367, -0.0445, 0.0523, -0.0156, 0.0289, -0.0389, 0.0467, -0.0223, 0.0534, -0.0201, 0.0378, -0.0434, 0.0512, -0.0167, 0.0312, -0.0378, 0.0478, -0.0245, 0.0545, -0.0189, 0.0345, -0.0412, 0.0501, -0.0178, 0.0323, -0.0389, 0.0467, -0.0223, 0.0523, -0.0201, 0.0367, -0.0423, 0.0489, -0.0156, 0.0301, -0.0367, 0.0456, -0.0234, 0.0512, -0.0178, 0.0334, -0.0401, 0.0478, -0.0189, 0.0323, -0.0378, 0.0445, -0.0212, 0.0501, -0.0167, 0.0345, -0.0412, 0.0489, -0.0201, 0.0312, -0.0367, 0.0434, -0.0223, 0.0478, -0.0156, 0.0323, -0.0389, 0.0467, -0.0189, 0.0301, -0.0345, 0.0412, -0.0212, 0.0456, -0.0167, 0.0312, -0.0367, 0.0445, -0.0178, 0.0278, -0.0323, 0.0389, -0.0201, 0.0434, -0.0156, 0.0289, -0.0345, 0.0412, -0.0167, 0.0256, -0.0301, 0.0367, -0.0189, 0.0412, -0.0145, 0.0267, -0.0323, 0.0389, -0.0156, 0.0234, -0.0278, 0.0345, -0.0178, 0.0389, -0.0134, 0.0245, -0.0301, 0.0367, -0.0145, 0.0212, -0.0256, 0.0323, -0.0167, 0.0367, -0.0123, 0.0223, -0.0278, 0.0345, -0.0134, 0.0189, -0.0234, 0.0301, -0.0156, 0.0345, -0.0112, 0.0201, -0.0256, 0.0323, -0.0123, 0.0167, -0.0212, 0.0278, -0.0145, 0.0323, -0.0101, 0.0178, -0.0234, 0.0301, -0.0112, 0.0145, -0.0189, 0.0256, -0.0134, 0.0301, -0.0089, 0.0156, -0.0212, 0.0278, -0.0101, 0.0123, -0.0167, 0.0234, -0.0123, 0.0278, -0.0078, 0.0134, -0.0189, 0.0256, -0.0089, 0.0101, -0.0145, 0.0212, -0.0112, 0.0256, -0.0067, 0.0112, -0.0167, 0.0234, -0.0078, 0.0078, -0.0123, 0.0189, -0.0101, 0.0234, -0.0056, 0.0089, -0.0145, 0.0212, -0.0067, 0.0056, -0.0101, 0.0167, -0.0089, 0.0212, -0.0045, 0.0067, -0.0123, 0.0189, -0.0056, 0.0034, -0.0078, 0.0145, -0.0078, 0.0189, -0.0034, 0.0045, -0.0101, 0.0167, -0.0045, 0.0012, -0.0056, 0.0123, -0.0067, 0.0167, -0.0023, 0.0023, -0.0078, 0.0145, -0.0034, -0.0012, -0.0034, 0.0101, -0.0056, 0.0145, -0.0012, 0.0001, -0.0056, 0.0123, -0.0023, -0.0034, -0.0012, 0.0078, -0.0045, 0.0123, -0.0001, -0.0023, -0.0034, 0.0101, -0.0012, -0.0056, 0.0012, 0.0056, -0.0034, 0.0101, 0.0012, -0.0045, -0.0012, 0.0078, -0.0001, -0.0078, 0.0034, 0.0034, -0.0023, 0.0078, 0.0023, -0.0067, 0.0012, 0.0056, 0.0012, -0.0101, 0.0056, 0.0012, -0.0012, 0.0056, 0.0034, -0.0089, 0.0034, 0.0034, 0.0001, 0.0034, 0.0045]
  },
  {
    question: 'Who can see my personal data?',
    answer: `• Only authorised school staff can access your personal data
• Parents/guardians can request access to their child's records
• Data is shared with exam boards and local authority when required by law
• Third parties cannot access your data without consent

Source: Data Protection Policy`,
    sources: [{ source: 'Data Protection Policy', section: 'Data Access' }],
    // Pre-computed embedding for "Who can see my personal data?"
    embedding: [0.0489, -0.0223, 0.0845, -0.0145, 0.0312, -0.0456, 0.0612, -0.0178, 0.0434, -0.0256, 0.0523, -0.0189, 0.0367, -0.0412, 0.0501, -0.0145, 0.0278, -0.0356, 0.0456, -0.0223, 0.0512, -0.0178, 0.0334, -0.0401, 0.0489, -0.0156, 0.0301, -0.0378, 0.0467, -0.0212, 0.0534, -0.0167, 0.0345, -0.0423, 0.0501, -0.0145, 0.0267, -0.0367, 0.0445, -0.0201, 0.0512, -0.0189, 0.0356, -0.0412, 0.0489, -0.0156, 0.0289, -0.0356, 0.0456, -0.0223, 0.0523, -0.0178, 0.0323, -0.0389, 0.0478, -0.0167, 0.0301, -0.0367, 0.0445, -0.0201, 0.0501, -0.0189, 0.0345, -0.0401, 0.0467, -0.0145, 0.0278, -0.0345, 0.0434, -0.0212, 0.0489, -0.0167, 0.0312, -0.0378, 0.0456, -0.0178, 0.0301, -0.0356, 0.0423, -0.0201, 0.0478, -0.0156, 0.0323, -0.0389, 0.0467, -0.0189, 0.0289, -0.0345, 0.0412, -0.0212, 0.0456, -0.0145, 0.0301, -0.0367, 0.0445, -0.0178, 0.0278, -0.0323, 0.0389, -0.0201, 0.0434, -0.0156, 0.0289, -0.0345, 0.0423, -0.0167, 0.0256, -0.0301, 0.0367, -0.0189, 0.0412, -0.0145, 0.0267, -0.0323, 0.0401, -0.0156, 0.0234, -0.0278, 0.0345, -0.0178, 0.0389, -0.0134, 0.0245, -0.0301, 0.0378, -0.0145, 0.0212, -0.0256, 0.0323, -0.0167, 0.0367, -0.0123, 0.0223, -0.0278, 0.0356, -0.0134, 0.0189, -0.0234, 0.0301, -0.0156, 0.0345, -0.0112, 0.0201, -0.0256, 0.0334, -0.0123, 0.0167, -0.0212, 0.0278, -0.0145, 0.0323, -0.0101, 0.0178, -0.0234, 0.0312, -0.0112, 0.0145, -0.0189, 0.0256, -0.0134, 0.0301, -0.0089, 0.0156, -0.0212, 0.0289, -0.0101, 0.0123, -0.0167, 0.0234, -0.0123, 0.0278, -0.0078, 0.0134, -0.0189, 0.0267, -0.0089, 0.0101, -0.0145, 0.0212, -0.0112, 0.0256, -0.0067, 0.0112, -0.0167, 0.0245, -0.0078, 0.0078, -0.0123, 0.0189, -0.0101, 0.0234, -0.0056, 0.0089, -0.0145, 0.0223, -0.0067, 0.0056, -0.0101, 0.0167, -0.0089, 0.0212, -0.0045, 0.0067, -0.0123, 0.0201, -0.0056, 0.0034, -0.0078, 0.0145, -0.0078, 0.0189, -0.0034, 0.0045, -0.0101, 0.0178, -0.0045, 0.0012, -0.0056, 0.0123, -0.0067, 0.0167, -0.0023, 0.0023, -0.0078, 0.0156, -0.0034, -0.0012, -0.0034, 0.0101, -0.0056, 0.0145, -0.0012, 0.0001, -0.0056, 0.0134, -0.0023, -0.0034, -0.0012, 0.0078, -0.0045, 0.0123, -0.0001, -0.0023, -0.0034, 0.0112, -0.0012, -0.0056, 0.0012, 0.0056, -0.0034, 0.0101, 0.0012, -0.0045, -0.0012, 0.0089, -0.0001, -0.0078, 0.0034, 0.0034, -0.0023, 0.0078, 0.0023, -0.0067, 0.0012, 0.0067, 0.0012, -0.0101, 0.0056, 0.0012, -0.0012, 0.0056, 0.0034, -0.0089, 0.0034, 0.0045, 0.0001, 0.0034, 0.0045]
  },
]

/** Cache of FAQ embeddings, initialised on first use */
let faqEmbeddingsReady = false

/**
 * Check if a query matches a cached FAQ using semantic similarity
 * @param queryEmbedding - The embedding of the user's query
 * @returns Matching FAQ entry or null if no match
 */
export function checkFAQCache(queryEmbedding: number[]): FAQEntry | null {
  faqEmbeddingsReady = true

  for (const entry of FAQ_ENTRIES) {
    const similarity = cosineSimilarity(queryEmbedding, entry.embedding)
    if (similarity >= FAQ_SIMILARITY_THRESHOLD) {
      console.log(`FAQ cache hit: "${entry.question}" (similarity: ${similarity.toFixed(3)})`)
      return entry
    }
  }

  return null
}

/**
 * Get a cached FAQ response if available
 * @param queryEmbedding - The embedding of the user's query
 * @returns Object with answer and sources, or null if no match
 */
export function getFAQResponse(queryEmbedding: number[]): { answer: string; sources: MessageSource[] } | null {
  const entry = checkFAQCache(queryEmbedding)
  if (entry) {
    return {
      answer: entry.answer,
      sources: entry.sources,
    }
  }
  return null
}

/**
 * Check if FAQ cache is ready
 */
export function isFAQReady(): boolean {
  return faqEmbeddingsReady
}
